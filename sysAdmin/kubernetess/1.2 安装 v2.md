---
tags:
  - none
---
> 2024-03-15
> {{author}}
> cyo57
> 
> {{env}}
> CentOS7.9
> 
> {{k8s-version}}
> v1.29
# 安装

### 搭建集群方式

#### 单 master

优点
- 简单易部署
- 成本低
- 易于管理
缺点
- 存在单点故障风险
- 扩展性有限

#### 多 master
  
  优点
  - 通过负载均衡
  - 高可用性
  - 高拓展性

#### 通过kubeadm部署

官方推出的快速部署工具，两台指令完成部署

> [!note]
> 本次示例使用 1Master + 2Node
> 
> time-2024-03-25

要求：
- master 节点
- node 节点

操作：
- 基础环境
```bash
# 关闭防火墙
systemctl disable --now firewalld
# 关闭SELinux
	# 安装 selinux-utils 可使用 getenforce
setenforce 0
#vim /etc/selinux/config

# 关闭swap
sed -ri 's/.*swap.*/#&/' /etc/fstab
swapoff -a 

# 设置主机名
# 配置hosts
# IPv4传递到iptables链
cat > /etc/sysctl.d/k8s.conf << EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward=1
vm.swappiness=0
EOF
sysctl --system

# 加载br_netfilter模块
modprobe br_netfilter
lsmod |grep br_netfilter

# 配置ipvs转发(all node)
yum -y install ipset ipvsadm

# 配置ipvsadm模块加载方式
# 添加需要加载的模块
mkdir -p /etc/sysconfig/ipvsadm
cat > /etc/sysconfig/ipvsadm/ipvs.modules <<EOF
#!/bin/bash
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack
EOF

# 时间同步
ntpdate ntp.aliyun.com

```

- ipvsadm 配置
```bash
# 安装 ipset 及 ipvsadm
yum -y install ipset ipvsadm

# 配置ipvsadm
vim /etc/sysconfig/modules/ipvs.modules
# 文件内添加
i
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack

# 然后执行命令
chmod 755 /etc/sysconfig/modules/ipvs.modules && bash /etc/sysconfig/modules/ipvs.modules
```

> [!WARNING]
> Kubernetes v1.24移除docker-shim的支持，而Docker Engine默认又不支持CRI标准，因此二者默认无法再直接集成。为此，Mirantis和Docker联合创建了cri-dockerd项目，用于为Docker Engine提供一个能够支持到CRI规范的桥梁，从而能够让Docker作为Kubernetes容器引擎。

- 安装 Docker CE (all nodes)
```bash
yum install -y yum-utils device-mapper-persistent-data lvm2
yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
sed -i 's+download.docker.com+mirrors.aliyun.com/docker-ce+' /etc/yum.repos.d/docker-ce.repo
yum makecache
yum -y install docker-ce

# 配置cgroup驱动及镜像
#vi /etc/docker/daemon.json
i
{
	"exec-opts": ["native.cgroupdriver=systemd"],
	"registry-mirrors": [
		"https://registry.docker-cn.com",
		"https://docker.mirrors.ustc.edu.cn"
	]
}

systemctl enable docker
systemctl start docker
systemctl status docker
docker info|grep systemd
```

- 安装cli-docker (all nodes)
```bash
#wget https://github.com/Mirantis/cri-dockerd/releases/download/<file.amd64.tgz>
yum install -y wget
wget http://gh-proxy.com/https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.11/cri-dockerd-0.3.11.amd64.tgz

tar xf cri-dockerd-*.amd64.tgz
mv cri-dockerd/cri-dockerd /usr/bin/
#rm -rf cri-dockerd cri-dockerd-0.3.9.amd64.tgz

# 配置启动项

cat > /etc/systemd/system/cri-docker.service<<EOF

[Unit]
Description=CRI Interface for Docker Application Container Engine
Documentation=https://docs.mirantis.com
After=network-online.target firewalld.service docker.service
Wants=network-online.target
Requires=cri-docker.socket

[Service]
Type=notify
ExecStart=/usr/bin/cri-dockerd --pod-infra-container-image=registry.k8s.io/pause:3.9 --container-runtime-endpoint fd://
ExecReload=/bin/kill -s HUP $MAINPID
TimeoutSec=0
RestartSec=2
Restart=always
StartLimitBurst=3
StartLimitInterval=60s
LimitNOFILE=infinity
LimitNPROC=infinity
LimitCORE=infinity
TasksMax=infinity
Delegate=yes
KillMode=process

[Install]
WantedBy=multi-user.target
EOF


cat > /etc/systemd/system/cri-docker.socket <<EOF
[Unit]
Description=CRI Docker Socket for the API
PartOf=cri-docker.service

[Socket]
ListenStream=%t/cri-dockerd.sock
SocketMode=0660
SocketUser=root
SocketGroup=docker

[Install]
WantedBy=sockets.target
EOF


systemctl daemon-reload
systemctl enable cri-docker
systemctl start cri-docker
systemctl status cri-docker
```

- 安装必要软件包
```bash
# 配置k8s源
cat <<EOF | tee /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.29/rpm/
enabled=1
gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.29/rpm/repodata/repomd.xml.key
EOF
setenforce 0
yum install -y kubelet kubeadm kubectl
```

- 配置 kubeadm
```bash
# 修改文件
echo KUBELET_EXTRA_ARGS="--cgroup-driver=systemd" > /etc/sysconfig/kubelet

# 修改完成后执行
systemctl enable kubelet #设置开机启动
```

- 镜像下载
```bash
# 查看 K8S 所需要的镜像文件
kubeadm config images list

# 下载镜像 (需要挂 vpn )
# kubeadm config pull --cri-socket unix:///var/run/cri-dockerd.sock

# 若没有 vpn 可以使用阿里的镜像源下载 registry.aliyuncs.com/google_containers
# 执行docker pull 命令下载

docker pull registry.aliyuncs.com/google_containers/xxx

# 下载完成后重新 tag 所有镜像
docker tag registry.aliyuncs.com/google_containers/kube-apiserver:v1.29.0 registry.k8s.io/kube-apiserver:v1.29.0

```

- 集群初始化
```bash
masterIP=192.168.100.20
version=v12.9.3
kubeadm init  --kubernetes-version $version \
              --apiserver-advertise-address $masterIP \
              --pod-network-cidr=10.244.0.0/16 \
              --cri-socket unix:///var/run/cri-dockerd.sock
```

> [!WARNING]
> 很可能会遇到像这样的错误
> ```
> [ERROR ImagePull]: failed to pull image registry.k8s.io/kube-proxy:v1.29.3: output: E0325 13:12:49.629192
> ```
>  
>  此时需要手动去阿里云拉取对应的镜像
>   `docker pull registry.aliyuncs.com/google_containers/<name>:<tag>` ，手动 docker tag 将名称替换为 `registry.k8s.io/<name>:<tag>`

- worker 节点加入集群

> [!tips]
> 按照日志说明，执行以下步骤
> ```bash
> mkdir -p $HOME/.kube
> sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
> sudo chown $(id -u):$(id -g) $HOME/.kube/config
> # if you are root user
> export KUBECONFIG=/etc/kubernetes/admin.conf
> ```


```bash
masterToken=ce83e8.ww2nidmp40ldy9hj
masterTokenCAHash=sha256:89a2d46f54e78d3babf21ea353f82504d74ef1596bd75265e26c38c2b56370a2
masterIP=192.168.100.20
kubeadm join $masterIP:6443 --token $masterToken \
	--discovery-token-ca-cert-hash $masterTokenCAHash \
	--cri-socket unix:///var/run/cri-dockerd.sock
```

- 安装 Calico
```bash
# 下载 https://github.com/projectcalico/calico/blob/master/manifests/tigera-operator.yaml
# 下载 https://github.com/projectcalico/calico/blob/master/manifests/custom-resources.yaml
tigera-url=https://github.com/projectcalico/calico/blob/master/manifests/tigera-operator.yaml
custom-res-url=https://github.com/projectcalico/calico/blob/master/manifests/custom-resources.yaml
wget $tigera-url
wget $custom-res-url

# 修改文件内ip为 10.244.0.0/16 后执行
kubectl create -f tigera-operator.yaml
kubectl create -f custom-resources.yaml

# 下载镜像包
calicourl=https://github.com/projectcalico/calico/releases/<filename>.tgz
wget https://gh-proxy.com/$calicourl

# 下载完成后解压 把内部的 images 全都导入到 docker 中
docker load < calico-cni.tar

# 查看状态
kubectl get nodes

```

## 参考资料

* [Centos7 安装 K8S v1.29.0](https://zhuanlan.zhihu.com/p/675530751)
* [Centos7 安装Docker、cri-docker](https://zhuanlan.zhihu.com/p/675352559)
