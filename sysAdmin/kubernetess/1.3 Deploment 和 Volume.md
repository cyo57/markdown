---
Created: "250430"
Modified: "250430"
tags:
  - k8s
---
## 存储 Volume

> **Volume (存储卷)** 是用来给 Pod 中的容器提供**持久化或共享存储**的一种机制。
> 
> 容器本身是临时的，重启或删除后数据会丢失。Volume 允许你将数据存储在容器外部，即使容器或 Pod 被销毁重建，数据也能保留下来。
> 同一个 Pod 中的多个容器可以挂载同一个 Volume，方便它们之间共享文件或数据。

### 类型

#### emptyDir

- Pod 分配到节点自动时创建，移除时删除
- 数据**不持久化**，与 Pod 生命周期绑定

生成一个 Pod 容器来测试

```shell
kubectl run test-pod-pv --image nginx --dry-run=client -o yaml > test-pod-pv.yaml
```

修改文件，加入 Volume 配置

```yaml
apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: null
  labels:
    run: test-pod-pv
  name: test-pod-pv
spec:
  volumes: # 创建两个 Volume
  - name: volume1
    emptyDir: {} # Volume 类型
  - name: volume2
    emptyDir: {}
  containers:
  - image: nginx
    name: test-pod-pv
    resources: {}
    volumeMounts: # 映射 Volume 到容器
    - name: volume1 # 和 Volume 名字相同
      mountPath: /app/temp-data1 # 容器内路径
  - image: nginx # 这里在一个 Pod 中放两个容器，测试共享 Volume
    name: test-pod-pv2
    command: ["sh","-c","sleep 10000"] # 添加 sleep 否则两个容器抢占 80 导致异常退出
    resources: {}
    volumeMounts: # 映射 Volume 到容器
    - name: volume1 # 和 Volume 名字相同
      mountPath: /app/temp-data2 # 容器内路径
  dnsPolicy: ClusterFirst
  restartPolicy: Always
status: {}
```

应用配置文件

```shell
root@k8smaster:~# kubectl apply -f test-pod-volume.yaml 
pod/test-pod-pv created
root@k8smaster:~# kubectl get po -o wide
NAME          READY   STATUS    RESTARTS   AGE   IP              NODE       NOMINATED NODE   READINESS GATES
test-pod-pv   2/2     Running   0          5s    10.244.249.22   k8snode1   <none>           <none>         <none>
root@k8smaster:~#
root@k8smaster:~# kubectl exec -it test-pod-pv -c test-pod-pv2  -- ls -ahl /app
total 12K
drwxr-xr-x 3 root root 4.0K Apr 30 15:59 .
drwxr-xr-x 1 root root 4.0K Apr 30 15:59 ..
drwxrwxrwx 2 root root 4.0K Apr 30 15:58 temp-data1
```


查询 emptyDir 在**对应节点**宿主机的路径，当一个pod中有两个容器时，可以使用-c命令，指定进入一个容器内

```shell
root@k8snode1:~# crictl ps
CONTAINER           IMAGE               CREATED             STATE               NAME                        ATTEMPT             POD ID              POD
d28b88e4c7c19       a830707172e80       7 minutes ago       Running             test-pod-pv                 0                   391d058d5661b       test-pod-pv
root@k8snode1:~# crictl inspect d28b88e4c7c19 | grep mounts -A 10
    "mounts": [
      {
        "containerPath": "/app/temp-data1",
        "gidMappings": [],
        "hostPath": "/var/lib/kubelet/pods/a1e5d4a6-e0a9-4a41-a6b5-a498f7165f0e/volumes/kubernetes.io~empty-dir/volume1",
        "propagation": "PROPAGATION_PRIVATE",
        "readonly": false,
        "selinuxRelabel": false,
        "uidMappings": []
      },
```
#### hostPath

- 将**节点宿主系统**中的文件或目录挂载到 Pod 中
- 数据持久化，如果 Pod 被调度到**不同的节点**上，它将访问到**不同**节点上的文件或目录，数据无法同步
- **不推荐**使用，因为降低了 Pod 的可移植性。通常用于需要访问节点特定资源或系统文件的 Pods

`hostPath` 就是直接把节点上的某个路径“映射”到容器里，和 `emptyDir` 挂载卷的方式是一样的，只不过是我们自定义的目录。

```shell
kubectl run test-pod-volume2 --image nginx --dry-run=client -o yaml > test-pod-volume2.yaml
```

```yaml
apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: null
  labels:
    run: test-pod-volume2
  name: test-pod-volume2
spec:
  volumes:
  - name: v1
    hostPath:
      path: /data/vol1
  containers:
  - image: nginx
    name: nginx
    resources: {}
    volumeMounts:
    - name: v1
      mountPath: /v1-data
  dnsPolicy: ClusterFirst
  restartPolicy: Always
status: {}
```

#### nfs

- 网络文件系统存储卷
- Pod 可以挂载 NFS 共享目录
- **数据持久化**，可以被多个 Pod 同时挂载

#### CephFS

- pass

#### iscsi


### 持久化存储