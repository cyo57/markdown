---
tags:
  - k8s
date: "250429"
---

## 环境配置
### metrics-server

> Metrics-server 收集节点和 Pod 的资源使用指标，并通过 Metrics API 提供这些数据，是 Kubernetes 自动化伸缩和资源监控的基础。它使得 HPA、VPA 以及 `kubectl top` 命令能够获取实时的 CPU 和内存使用情况。

拉取官方 [yaml](https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.7.2/components.yaml)

修改配置文件

```yaml
spec:
      containers:
      - args:
        # 忽略TLS
        - --kubelet-insecure-tls
		# 修改镜像源
        image: **registry.cn-hangzhou.aliyuncs.com/cloudcs/metrics-server:v0.6.2**
```

#### 基本命令

查看所有节点的资源使用

```shell
kubectl top nodes

root@k8smaster:~# kubectl top node
NAME        CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   
k8smaster   101m         5%     2205Mi          58%       
k8snode1    38m          1%     1291Mi          34%       
k8snode2    38m          1%     1248Mi          33%       
root@k8smaster:~# 
```

## Namespace

> Namespace 在 Kubernetes 中提供了一种机制，用于将集群中的资源（如 Pod、Service、Deployment 等）划分为相互隔离的逻辑组。
> 
>  不同 namespace 的 pod 相互隔离，避免不同团队或应用之间的命名冲突，并可以用于资源配额管理。

### 列出 namespace

```shell
kubectl get namespaces

root@k8smaster:~# kubectl get namespaces
NAME               STATUS   AGE
calico-apiserver   Active   92m
calico-system      Active   92m
default            Active   16h
kube-node-lease    Active   16h
kube-public        Active   16h
kube-system        Active   16h
tigera-operator    Active   92m
```

### 创建 namespace

```shell
kubectl create namespace <namespace-name>

root@k8smaster:~# kubectl create namespace cloudhnjm
namespace/cloudhnjm created
root@k8smaster:~# kubectl get ns
NAME               STATUS   AGE
calico-apiserver   Active   93m
calico-system      Active   93m
cloudhnjm          Active   8s
default            Active   16h
kube-node-lease    Active   16h
kube-public        Active   16h
kube-system        Active   16h
tigera-operator    Active   93m
```

也可以通过 YAML 文件创建，`kubectl apply -f my-app-ns.yaml`

my-app-ns.yaml
```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: my-app
```

### 删除 namespace

```shell
kubectl delete namespace

root@k8smaster:~# kubectl create namespace temp
namespace/temp created
root@k8smaster:~# kubectl delete namespace temp
namespace "temp" deleted
root@k8smaster:~#
```

### 查看当前所在的命名空间

```shell
kubectl config get-contexts

root@k8smaster:~# kubectl config get-contexts
CURRENT   NAME                          CLUSTER      AUTHINFO           NAMESPACE
*         kubernetes-admin@kubernetes   kubernetes   kubernetes-admin   
```

### 切换命名空间

```shell
kubectl config set-context --current --namespace kube-system

root@k8smaster:~# kubectl config set-context --current --namespace kube-system
Context "kubernetes-admin@kubernetes" modified.
root@k8smaster:~# kubectl config get-contexts
CURRENT   NAME                          CLUSTER      AUTHINFO           NAMESPACE
*         kubernetes-admin@kubernetes   kubernetes   kubernetes-admin   kube-system
root@k8smaster:~# 
root@k8smaster:~# kubectl get po -A
NAMESPACE          NAME                                      READY   STATUS    RESTARTS       AGE
calico-apiserver   calico-apiserver-77b9c64bc5-59ctd         1/1     Running   4 (66m ago)    69m
calico-apiserver   calico-apiserver-77b9c64bc5-d57xm         1/1     Running   3 (67m ago)    69m
calico-system      calico-kube-controllers-b69db776c-xhtb8   1/1     Running   0              69m
calico-system      calico-node-cth2r                         1/1     Running   0              69m
calico-system      calico-node-mm9ct                         1/1     Running   0              69m
calico-system      calico-node-txssf                         1/1     Running   0              69m
calico-system      calico-typha-6cdcbdcd9-72ghb              1/1     Running   0              69m
calico-system      calico-typha-6cdcbdcd9-w5gxk              1/1     Running   0              68m
calico-system      csi-node-driver-bpqm2                     2/2     Running   0              69m
calico-system      csi-node-driver-ndm7v                     2/2     Running   0              69m
calico-system      csi-node-driver-rhlxr                     2/2     Running   0              69m
kube-system        coredns-66f779496c-64q8g                  1/1     Running   1 (122m ago)   16h
kube-system        coredns-66f779496c-b6vs6                  1/1     Running   1 (122m ago)   16h
kube-system        etcd-k8smaster                            1/1     Running   3 (122m ago)   16h
kube-system        kube-apiserver-k8smaster                  1/1     Running   3 (122m ago)   16h
kube-system        kube-controller-manager-k8smaster         1/1     Running   3 (122m ago)   16h
kube-system        kube-proxy-chwzb                          1/1     Running   3 (80m ago)    16h
kube-system        kube-proxy-tpjm5                          1/1     Running   1 (122m ago)   16h
kube-system        kube-proxy-vcnz7                          1/1     Running   2 (81m ago)    16h
kube-system        kube-scheduler-k8smaster                  1/1     Running   3 (122m ago)   16h
kube-system        metrics-server-5796b7676f-d7lcs           1/1     Running   0              12m
tigera-operator    tigera-operator-c78c656bf-8krn9           1/1     Running   0              69m
```

| 名称        | 含义                                                                                                                           |
| --------- | ---------------------------------------------------------------------------------------------------------------------------- |
| NAMESPACE | 所属的命名空间                                                                                                                      |
| NAME      | Pod 的名称，在同一个命名空间内是唯一的                                                                                                        |
| READY     | `1/1` 表示 Pod 中有 1 个容器且已就绪                                                                                                    |
| STATUS    | Pod 的当前状态<br>常见的有 `Running` (正在运行), `Pending` (等待调度), `Succeeded` (成功完成), `Failed` (失败), `CrashLoopBackOff` (容器崩溃后正在重启循环) 等。 |
| RESTARTS  | Pod 中容器重启的总次数。括号中的时间表示最后一次重启发生的时间距离现在多久。                                                                                     |
| AGE       | Pod 的运行时间（当 Pod 中的容器重启时，`AGE` 不会刷新。容器重启是 Pod 内部发生的事情，Pod 对象本身并没有被删除重建，所以它的创建时间不会改变，`AGE` 会继续增长。）                             |
| RESTARTS  | Pod 中容器重启的总次数                                                                                                                |
| AGE       | Pod 运行了多久                                                                                                                    |


因为 k8s 切换命名空间较为繁琐，可以使用社区工具 [kubectx](https://github.com/ahmetb/kubectx) 中的 `kubens` 进行切换

```shell
chmod +x kubens
mv kubenv /usr/local/bin/kubens
```

### 指定命令在特定的 Namespace 中执行

当执行 `kubectl get`, `kubectl apply`, `kubectl delete`, `kubectl logs` 等命令时，如果不指定 Namespace，它默认会在当前的上下文 (Context) 设置的 Namespace 中执行

对特定 Namespace 中的资源进行操作，使用 `-n` 或 `--namespace` 标志。

```shell
kubectl get pods -n <namespace-name>        # 查看指定 Namespace 下的 Pods
kubectl get services -n kube-system         # 查看 kube-system Namespace 下的 Services
kubectl apply -f my-resource.yaml -n my-app # 在 my-app Namespace 中创建资源
kubectl delete pod <pod-name> -n my-app     # 删除 my-app Namespace 下的 Pod
kubectl logs <pod-name> -n my-app           # 查看 my-app Namespace 下 Pod 的日志
```

如果你想查看**所有** Namespace 下的某种资源，可以使用 `-A` 或 `-all-namespaces`

```shell
kubectl get services -A
kubectl get pod -A
```


## Pod

> Pod 是 Kubernetes 中最小的可部署单元，它是应用程序的单个实例或一组紧密关联的容器的集合。
> 同一个 Pod 中的容器共享网络命名空间、存储卷等资源，它们通常一起调度到同一个节点上，并且应该被视为一个单一的管理单元。

> 通常一个 Pod 推荐只有一个容器

### 创建 Pod

创建 Pod 可以通过 CLI 和 Yaml 文件，推荐后者

#### 通过 CLI

```shell
kubectl run <PodName> --image <ImageName>

root@k8smaster:~# kubectl run nginx-1 --image nginx
pod/nginx-1 created
root@k8smaster:~# kubectl get po
NAME      READY   STATUS              RESTARTS   AGE
nginx-1   0/1     ContainerCreating   0          21s
root@k8smaster:~# kubectl get po
NAME      READY   STATUS    RESTARTS   AGE
nginx-1   1/1     Running   0          25s
root@k8smaster:~# 
```

#### 查看 Pod 信息

查看所在节点和IP

```shell
kubectl get pod -o wide

root@k8smaster:~# kubectl get pod -o wide
NAME      READY   STATUS    RESTARTS   AGE     IP               NODE       NOMINATED NODE   READINESS GATES
nginx-1   1/1     Running   0          2m10s   10.244.185.197   k8snode2   <none>           <none>
```

查看描述信息

```shell
kubectl describe pod <PodName>
```

#### 镜像下载策略 --image-pull-policy

 > 决定了 Kubelet 何时尝试从镜像仓库拉取镜像。

- Always
	- 每次启动都尝试拉取最新，即使本地已经存在也会重新拉取摘要（如果版本一样则不重新拉取）
- IfNotPresent
	- 默认策略
	- 如果本地存在镜像，就不会拉取远端最新镜像。
- Never
	- 永远不拉取镜像，如果本地不存在，则会启动失败

```shell
kubectl run <PodName> --image <ImageName> --image-pull-policy <ImagePullPolicy>
```

#### 通过 yaml

yaml文件不需要从0开始编写，可以 通过命令生成一个基础版本，在此版本上进行修改，增加配置

```shell
kubectl run pod-test --image nginx --image-pull-policy IfNotPresent --dry-run=client -o yaml > pod-test.yaml
```

pod-test.yaml
```yaml
apiVersion: v1
kind: Pod # 资源类型
metadata:
  creationTimestamp: null # 创建时间戳，null会系统自动生成
  labels: # 标签
    run: pod-test
  name: pod-test # Pod名称，在同Namespace中唯一
spec:
  # 容器列表（一个pod可包含多容器）
  containers:
  - image: nginx
    imagePullPolicy: IfNotPresent
    name: pod-test # Pod内的容器名称，在同Pod内唯一
    resources: {} # 资源限制（CPU、内存等）。这里未指定
  dnsPolicy: ClusterFirst
  restartPolicy: Always
status: {}
```

使用 `kubectl apply -f <File>` 创建/更新现有资源
使用 `kubectl create -f <File>` 创建资源，无法更新资源


### 进入 Pod

#### 通过 Pod 名称

```shell
kubectl exec -it <PodName> -- <Command>
```

> 添加 `--` 可以让 `kubectl` 明确知道 `<Command>` 的参数传递给容器，而不是作为 `kubectl exec` 的参数

#### 通过 Yaml

```shell
kubectl exec -it -f <File> -- <Command>
```

### 删除 Pod

#### 通过 CLI

```
kubectl delete pod <PodName>
```

#### 通过 yaml

```shell
kubectl delete -f <File>
```

### Pod 生命周期

> 一个 Pod 的生命周期，就像一个 Docker 容器从创建到运行再到结束的过程，只不过在 Kubernetes 里，这个过程被管理得更精细。

- **Pending**：等待中，Kubernetes 需要决定把这个 Pod 放在哪个节点（也就是哪台机器）上运行，这个过程叫“调度”。然后对应节点的 Kubelet 需要去拉取容器镜像，Pod 就会处于这个 Pending 状态。
- **Running**：容器成功启动
- **Succeeded**：如果退出码是 0（表示成功），那么 Pod 的状态就会变成 Succeeded。
- **Failed**：Pod 里的容器在运行过程中崩溃了，或者以非零的退出码结束
- **CrashLoopBackOff** ：如果一个 Pod 里的容器启动后很快就崩溃并退出了（进入 Failed 状态），Kubernetes 会尝试重启它。如果它反复地启动、崩溃、再启动、再崩溃，就会进入 CrashLoopBackOff 状态。Kubernetes 会以指数退避的方式（等待时间越来越长）尝试重启，避免无限循环地快速重启耗尽资源

#### restartPolicy

> 当 Pod 里的容器停止运行时的行为

在一个默认 yaml 中，Always作为默认值

```yaml
apiVersion: v1
kind: Pod # 资源类型
metadata:
  creationTimestamp: null # 创建时间戳，null会系统自动生成
  labels: # 标签
    run: pod-test
  name: pod-test # Pod名称，在同Namespace中唯一
spec:
  # 容器列表（一个pod可包含多容器）
  containers:
  - image: nginx
    imagePullPolicy: IfNotPresent
    name: pod-test # Pod内的容器名称，在同Pod内唯一
    resources: {} # 资源限制（CPU、内存等）。这里未指定
  dnsPolicy: ClusterFirst # DNS策略
  restartPolicy: Always
status: {}
```

- **Always**：不管容器是因为什么原因停止的（正常退出，或者崩溃），Kubernetes 都会尝试重新启动它。
- **OnFailure**：只有当容器以非零的退出码（表示失败）停止时，Kubernetes 才会尝试重新启动它。
- **Never**：容器停止后，Kubernetes 永远不会尝试重新启动它

### apiversion 和 api-resources

可以通过命令进行查看KIND，APIVERSION，NAME之间的关系

```shell
kubectl api-versions

kubectl api-resources
```


### 静态 Pod

