---
tags:
  - flask
Created: "20241223"
Modified: "20241223"
---
## Flask Model

Flask 默认没有提供数据库操作的 API，我们可以选择适合自己项目的数据库使用

Flask 中可以选择原生语句实现，也可以选择 ORM

> [!tip]
> 通常不使用原生 SQL
> - 代码利用率低，相似语句多，复杂语句长
> - 业务逻辑不便修改
### ORM

Flask 通过 Model 操作数据库，自动生成相应数据库类型的 SQL 语句，所以不需要关心 SQL 语句和类型，我们只要会写 Model 就可以了。

Flask 使用关系映射 ORM 框架操作数据库

Flask 使用 Python 自带 ORM: `SQLAlchemy`，针对于 Flask 支持我们使用插件 `flask-sqlalchemy`

安装必要包
```shell
flask-sqlalchemy # ORM
flask-migrate # 数据迁移
pymysql # 数据库驱动
```


### 创建模型

./App/exts.py
```python
from flask_sqlalchemy import SQLAlchemy
from flask_migrate import Migrate 

# 数据库迁移
# 初始化
db = SQLAlchemy() # ORM 对象
migrate = Migrate()

# 绑定 app 对象
def init_exts(app):
    db.init_app(app=app)
    migrate.init_app(app=app, db=db)
```

./App/\_\_init__.py
```python
from .exts import init_exts
```

./App/models.py
```python
from .exts import db

# 创建模型 (Class)
class User(db.Model):
    # 定义表名
    __tablename__ = 'user'
    # 定义字段
    id = db.Column(db.Integer, primary_key=True, autoincrement=True)
    userid = db.Column(db.Integer, unique=True, nullable=False, index=True)
    username = db.Column(db.String(20), default='新用户')
    password = db.Column(db.String(20), nullable=False)

```

### 数据迁移 Flask-Migrate

目标： 使用 Flask-Migrate 管理数据库结构变更，实现版本控制，确保不同环境数据库一致性，并支持团队协作开发。

1. 定位项目目录 (`./app.py` 同级)
2. 初始化迁移环境
```shell
flask db init # 创建迁移目录
flask db migrate # 生成迁移文件
flask db upgrade # 迁移文件升级
flask db downgrade # 迁移文件降级
```

使用 `flask db migrate` 将会生成新的文件 `./App/migrations/versions/xxx.py`，文件记录了数据库结构变更，包含升级和降级操作，用于版本控制，保证数据库在不同环境一致性，并支持协作开发。

3. 升级数据库
将当前数据库应用所有未执行的迁移文件，更新数据库结构。

4. 降级数据库
回滚数据库到一个旧的版本（指定版本号）。

> [!tip]
> **模型修改后必须迁移：** 每次修改数据库模型（例如，在 `models.py` 文件中修改表结构）后，必须重新执行 `flask db migrate` 和 `flask db upgrade`，以同步数据库结构，否则更改不会生效。
