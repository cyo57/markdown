---
tags:
  - flask
Created: "20241223"
Modified: "20240112"
---

## Flask Model

Flask 默认没有提供数据库操作的 API，我们可以选择适合自己项目的数据库使用

Flask 中可以选择原生语句实现，也可以选择 ORM

> [!tip]
> 通常不使用原生 SQL
> - 代码利用率低，相似语句多，复杂语句长
> - 业务逻辑不便修改
### ORM

Flask 通过 Model 操作数据库，自动生成相应数据库类型的 SQL 语句，所以不需要关心 SQL 语句和类型，我们只要会写 Model 就可以了。

Flask 使用关系映射 ORM 框架操作数据库

Flask 使用 Python 自带 ORM: `SQLAlchemy`，针对于 Flask 支持我们使用插件 `flask-sqlalchemy`

安装必要包
```shell
flask-sqlalchemy # ORM
flask-migrate # 数据迁移
pymysql # 数据库驱动
```


### 创建模型

./App/exts.py
```python
from flask_sqlalchemy import SQLAlchemy
from flask_migrate import Migrate 

# 数据库迁移
# 初始化
db = SQLAlchemy() # ORM 对象
migrate = Migrate()

# 绑定 app 对象
def init_exts(app):
    db.init_app(app=app)
    migrate.init_app(app=app, db=db)
```

./App/\_\_init__.py
```python
from .exts import init_exts
```

./App/models.py
```python
from .exts import db

# 创建模型 (Class)
class User(db.Model):
    # 定义表名
    __tablename__ = 'user'
    # 定义字段
    id = db.Column(db.Integer, primary_key=True, autoincrement=True)
    userid = db.Column(db.Integer, unique=True, nullable=False, index=True)
    username = db.Column(db.String(20), default='新用户')
    password = db.Column(db.String(20), nullable=False)

```


### 数据迁移 Flask-Migrate

目标： 使用 Flask-Migrate 管理数据库结构变更，实现版本控制，确保不同环境数据库一致性，并支持团队协作开发。

1. 定位项目目录 (`./app.py` 同级)
2. 初始化迁移环境
```shell
flask db init # 创建迁移目录
flask db migrate # 生成迁移文件
flask db upgrade # 迁移文件升级
flask db downgrade # 迁移文件降级
```

使用 `flask db migrate` 将会生成新的文件 `./App/migrations/versions/xxx.py`，文件记录了数据库结构变更，包含升级和降级操作，用于版本控制，保证数据库在不同环境一致性，并支持协作开发。

3. 升级数据库
将当前数据库应用所有未执行的迁移文件，更新数据库结构。

4. 降级数据库
回滚数据库到一个旧的版本（指定版本号）。

> [!warning] **模型修改后必须迁移**
> 每次修改数据库模型（例如，在 `models.py` 文件中修改表结构）后，必须重新执行 `flask db migrate` 和 `flask db upgrade`，以同步数据库结构，否则更改不会生效。


## 单表操作

实现一个用户注册的逻辑

### 增 - 用户注册

- 添加单条数据
./App/views.py
```python
# 注册路由
@blue.route('/register/', methods=['GET', 'POST'])
def register():
    # GET请求返回注册页面
    if request.method == 'GET':
        return render_template('register.html')  # 返回注册页面
    elif request.method == 'POST':  # POST请求处理注册逻辑
        userid = request.form.get('userid')
        username = request.form.get('username')
        password = request.form.get('password')

        # 判断账号和密码是否为空
        if userid and password:
            # 判断账号是否已被注册
            if User.query.filter_by(userid=userid).first():
                return '该账号已被注册'
            # 创建用户
            user = User(userid=userid, username=username, password=password)
            # 下边的代码等同于上边的代码
            # user.userid = userid
            # user.username = username
            # user.password = password
            db.session.add(user)
            db.session.commit()
            return redirect('/login/')
        else:
            return '账号和密码不能为空'
```

./App/templates/register.html
```html
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>LightingJM Register</title>
</head>
<body>
    <h1>注册</h1>
    <form action="/register/" method="post">
        <label for="userid">账号：</label>
        <input type="number" id="userid" name="userid" required>
        <br>
        <label for="username">昵称（选填）：</label>
        <input type="text" id="username" name="username">
        <br>
        <label for="password">密码：</label>
        <input type="password" id="password" name="password" required>
        <br>
        <button type="submit">注册</button>
    </form>
    <p>已有账号？<a href="/login/">去登录</a></p>
</body>
</html>
```

- 添加多条数据
./App/views.py
```python
# 批量添加用户
@blue.route('/debug/add_users/')
def add_users():
    if session.get('user') != 'admin':
        return render_template('index.html', error='权限不足')
    users = []
    for i in range(100,110):
        user = User(userid=i, username=f'用户{i}', password='123456')
        users.append(user)

    try:
        db.session.add_all(users)
        db.session.commit()
        return '添加成功'
    except IntegrityError as e:
        db.session.rollback()
        db.session.flush()
        return '用户ID已存在，请勿重复注册'
    except Exception as e:
        print(e)
        db.session.rollback()
        db.session.flush()
        return str(e)
```

> [!tip]
> **数据操作注意**
> - 添加单条数据使用 `db.session.add()` 
> - 批量添加数据使用 `db.session.add_all()`
> - 操作后必须使用 `db.session.commit()` 提交事务
> - 操作失败需要使用 `db.session.rollback()` 回滚
> 
> **异常处理**
> - 处理主键冲突等数据库异常
> - 使用 try-except 结构确保程序稳定性



### 查 - 用户登录

./App/views.py
```python
# 登录路由，支持GET和POST方法
@blue.route('/login/', methods=['GET', 'POST'])
def login():
	# 如果用户已登录则跳回首页
    if session.get('user'):
        return redirect('/')
    if request.method == 'GET':
        # GET请求返回登录页面
        return render_template('login.html')
    elif request.method == 'POST':
        # POST请求处理登录逻辑
        userid = request.form.get('userid')
        password = request.form.get('password')

        user = User.query.filter_by(userid=userid).first()
        if user and user.password == password:
            response = redirect('/')
            session['userid'] = user.userid
            session['user'] = user.username
            session.permanent = True
            return response
        else:
            return render_template('login.html', error='账号或密码错误')
```

./App/templates/register.html
```html
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>LightingJM Register</title>
</head>
<body>
    <h1>注册</h1>
    <form action="/register/" method="post">
        <label for="userid">账号：</label>
        <input type="number" id="userid" name="userid" required>
        <br>
        <label for="username">昵称（选填）：</label>
        <input type="text" id="username" name="username">
        <br>
        <label for="password">密码：</label>
        <input type="password" id="password" name="password" required>
        <br>
        <button type="submit">注册</button>
    </form>
    <p>已有账号？<a href="/login/">去登录</a></p>
</body>
</html>
```

### 改 - 修改信息

./App/templates/info.html
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人信息</title>
</head>
<body>
    <h1>个人信息</h1>
    <hr>
    <form action="/info/" method="post">
        <label for="username">昵称：</label>
        <input type="text" id="username" name="username" value="{{ username }}" required>
        <button type="submit">修改昵称</button>
    </form>
    
    <div class="info">
        <p>最后登陆时间：{{ lastlogin }}</p>
        <p>注册时间：{{ registertime }}</p>
    </div>

    <p><a href="/">返回首页</a></p>

</body>
</html>
```

./App/views.py
```python
# 查看个人信息
@blue.route('/info/', methods=['GET', 'POST'])
def info():
    username = session.get('username')
    userid = session.get('userid')
    if request.method == 'GET':
        if not username:
            return redirect('/login/')
        return render_template(
            'info.html',
            username=username,
            lastlogin=User.query.filter_by(userid=userid).first().last_login,
            registertime=User.query.filter_by(
                userid=userid).first().create_time
        )
    elif request.method == 'POST':
        if session.get('username') == 'admin':
            return render_template(
                'info.html',
                message='admin无法修改名称',
                username=username,
                lastlogin=User.query.filter_by(
                    userid=userid).first().last_login,
                registertime=User.query.filter_by(
                    userid=userid).first().create_time
            )
        new_name = request.form.get('username')
        user = User.query.filter_by(userid=userid).first()
        user.username = new_name
        # db.session.add(user)
        db.session.commit()
        session['username'] = user.username
        return redirect('/info/')
    else:
        return 'error'
```


## SQLAlchemy 使用
### 查


```python
users = User.query.filter()
# users <class 'list'>
# User.query <class 'flask_sqlalchemy.query.Query'>
```


